#!/bin/bash
# Check for argument and show usage 
if [ -z "$1" ]; then
  echo "Usage: $0 <filename>"
  exit 1
fi

# Convert semicolon to tab as delimiter, convert CRLF, convert decimal, delete non-ASCII. Store to variable cleaned
cleaned=$(cat "$1" | tr ';' '\t' | tr -d '\r' | sed 's/\([0-9]\),\([0-9]\)/\1.\2/g' | tr -cd '\0-\177')
header=$(echo "$cleaned" | head -n 1)
data=$(echo "$cleaned" | tail -n +2)

# Get highest value from first column
max_id=$(echo "$cleaned" | cut -f1 | grep -E '^[0-9]+$' | sort -n | tail -n 1 )
next_id=$((max_id + 1))

# Process each line in the cleaned data
final=$(echo "$data" | while IFS=$'\t' read -r first_column rest; do
    if [[ ! "$first_column" =~ ^[0-9]+$ ]]; then
        echo -e "${next_id}\t$first_column\t$rest"
        next_id=$((next_id + 1))
    else
        echo -e "$first_column\t$rest"
    fi
done)


mechanics_column=$(echo "$final" | cut -f13)


# Initialize an empty associative array to store mechanic counts
declare -A mechanic_counts

# Process each line of the extracted column
while IFS= read -r line; do
  # Split the line by comma and trim whitespace
  IFS=',' read -r -a mechanics <<< "$line"
  for mechanic in "${mechanics[@]}"; do
    # Trim leading/trailing whitespace
    trimmed_mechanic=$(echo "$mechanic" | xargs)
    if [[ -n "$trimmed_mechanic" ]]; then
      # Increment the count for the mechanic
      ((mechanic_counts["$trimmed_mechanic"]++))
    fi
  done
done <<< "$mechanics_column"

# Find the mechanic with the highest count
max_count=0
max_mechanic=""

for mechanic in "${!mechanic_counts[@]}"; do
  count="${mechanic_counts[$mechanic]}"
  if [[ "$count" -gt "$max_count" ]]; then
    max_count="$count"
    max_mechanic="$mechanic"
  fi
done

echo "The most popular game mechanics is $max_mechanic found in $max_count games."